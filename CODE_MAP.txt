# Volume Analysis Project - Code Map

**Last Updated**: 2025-11-16  
**Purpose**: Fast lookup for where core behaviors live so humans (and LLMs) can jump directly to the right module.

---

## Core Analysis Pipeline

**`vol_analysis.py`** - CLI entry point; wires data loading, indicator prep, signal generation, charting, and reporting for single tickers or batches.  
**`signal_generator.py`** - Implements entry/exit scoring, stealth accumulation flags, divergence checks, and publishes the per-bar signal payload.  
**`indicators.py`** - Hosts technical indicator functions (Anchored VWAP, ATR, z-score utilities, pre-trade filters, next-day references) shared across the stack.  
**`swing_structure.py`** - Detects pivots, builds swing levels, and emits proximity/failure signals used for stops and chart overlays.  
**`volume_features.py`** - Computes CMF, CMF z-scores, volume surprise, event-day markers, and volume divergence features.  
**`chart_builder.py`** - Renders three-panel matplotlib outputs with swing levels, event days, and entry/exit icons.  
**`batch_processor.py`** - Multi-ticker execution layer that ranks outputs, builds HTML summaries, and orchestrates batch scorecards.

---

## Data & Cache Layer

**`data_manager.py`** - Unified data access layer (Yahoo Finance + cached data) with schema versioning and date-range helpers.  
**`populate_cache.py` / `populate_cache_bulk.py`** - Populate or refresh cache files across ticker lists with progress reporting and error isolation.  
**`refresh_cache_rest.py`** - Massive REST API script for same-day data (requires Developer/Advanced tier; reference only).  
**`query_cache_range.py`** - CLI tool to inspect cached coverage, preview stats, and validate regime windows.  
**`schema_manager.py`** - Owns cache schema migrations and upgrade validation.  
**`massive_data_provider.py`** - Legacy Massive.com fetcher kept for replaying archived tests.

---

## Risk & Backtesting

**`risk_manager.py`** - Central trade lifecycle manager (position sizing, stop logic, time/momentum exits, performance rolls).  
**`backtest.py`** - Entry-to-exit pairing engine with P&L attribution routed through `RiskManager`.  
**`batch_backtest.py`** - Batch-oriented backtesting wrapper with regime/date filters and aggregate reporting.  
**`threshold_config.py`** - Houses calibrated thresholds for entry, exit, and quality filters.  
**`threshold_validation.py`** - Walk-forward framework that reuses the optimization pipeline to guard against drift.

---

## Support Modules & Utilities

**`regime_filter.py`** - Market/sector regime checks (SPY 200DMA, sector ETF 50DMAs, ETF mappings).  
**`utils.py`** - Generic helpers (I/O, formatting, math utilities).  
**`error_handler.py`** - Standardized error capture/reporting for CLI tools.  
**`chart_builder_plotly.py`** - Alternate visualization path for interactive dashboards.  
**`sector_dashboard*.py` / `sector_rotation.py`** - Sector-level analytics, momentum ranking, and reporting.

---

## Performance Analysis & Optimization

**Professional Evaluation**
- `analyze_professional_metrics.py` (NEW) - Calculates institutional-grade metrics
  - Maximum Drawdown (peak-to-trough equity decline)
  - Sharpe Ratio (risk-adjusted returns)
  - Win/Loss Ratio, Monthly consistency, Consecutive streaks
  - Professional grading (retail vs institutional assessment)
  - Outputs: `professional_evaluation.txt` with comprehensive report
  - Current Results: Grade A- (Sharpe 3.35, Drawdown -9.37%)

**Signal Quality Analysis**
- `analyze_trade_quality.py` - Signal optimization and threshold tuning
  - Performance by score buckets (0-4, 4-6, 6-8, 8-10)
  - Threshold optimization (find optimal cutoff points)
  - Entry-exit pairing analysis
  - Generates visualizations (scatter, box plots, heatmaps)
  - Helps identify which signals have statistical significance

**Portfolio Size Analysis**
- `analyze_portfolio_decomposition.py` - Portfolio size sensitivity analysis
  - Decomposes returns into Volume Effect (more trades) vs Sizing Effect (better trades)
  - Compares concentrated (10 tickers) vs diversified (40 tickers) portfolios
  - Shows if trade quality degrades with portfolio size
  - Helps decide optimal ticker count

**Expected Value Analysis**
- `calculate_realistic_expectations.py` - Weighted expected value calculator
  - Entry-exit path frequency matrix
  - Calculates what you'll ACTUALLY experience (weighted by probability)
  - Best-case vs typical-case scenarios
  - Shows exit path probabilities (e.g., Momentum only fires 20% of time)

**Educational Tools**
- `explain_exit_returns.py` - Explains entry vs exit return confusion
  - Why exit signals show higher returns than entry signals
  - Entry measures ALL trades, Exit measures filtered subset
  - Educational tool for interpreting backtest reports

**See:** `ANALYSIS_SCRIPTS_OVERLAP.md` for detailed purposes and workflow recommendations

---

## Testing & Validation Toolkit

**Unit / module tests**  
- `test_swing_structure.py`, `test_volume_features.py`, `test_risk_manager.py`

**Variable stop loss validation**
- `test_variable_stops.py` - Comprehensive testing framework for 5 stop strategies (4,249 trades validated)
  - Extends RiskManager without modifying production code
  - Time Decay winner: 1.52R avg (+22% vs 1.25R static baseline)  
  - Supports batch testing via ticker files (`--file` parameter)
  - Generates comparative reports and statistical validation

**Scenario / regression harness**  
- `test_massive_*` scripts, `tests/` directory fixtures

**Validation utilities**  
- `validate_execution_timing.py` - Check lookahead bias in execution
- `validate_outlier_impact.py` - Analyze extreme trade effects on averages
- `validate_signal_details.py` - Deep dive into specific signal performance
- `validate_walk_forward.py` - Test consistency across time periods
- `verify_threshold_disconnect.py` - Ensure threshold configs match actual usage
- `verify_trade_counts.py` - Reconcile trade counts across reports

---

## Dependency Snapshot

```
vol_analysis.py
├── data_manager.py
├── indicators.py
├── signal_generator.py
├── chart_builder.py
├── batch_processor.py
└── backtest.py

signal_generator.py
└── indicators.py

backtest.py
└── schema_manager.py
```

---

## Documentation & Reference

**Performance Analysis**
- `PROFESSIONAL_ANALYSIS_PLAN.md` - Professional metrics implementation plan
- `professional_evaluation.txt` - Current system evaluation (Grade A-, Institutional Quality)
- `ANALYSIS_SCRIPTS_OVERLAP.md` - Script purposes and overlap assessment

**Validation & Methodology**
- `STRATEGY_VALIDATION_COMPLETE.md` - Consolidated performance/validation findings  
- `BACKTEST_VALIDATION_METHODOLOGY.md` - Repeatable 4-step validation checklist  

**Cache & Data**
- `BULK_CACHE_POPULATION.md`, `docs/CACHE_SCHEMA.md` - Cache architecture and schema notes  

**Trading Strategy**
- `TRADING_STRATEGY.md`, `TRADING_STRATEGY_SECTOR_AWARE.md` - Trading rules, risk logic, and sector overlays  

**Session History**
- `SESSION_IMPROVEMENTS_SUMMARY.md`, `SESSION_COMPLETE_NOV_2025.md` - Running changelog/session context  

**Architecture**
- `docs/ARCHITECTURE_REFERENCE.md` - Conceptual overview complementing this code map
- `CODE_MAP.txt` - This file (module responsibilities and dependencies)

---

**Maintenance**: Update when modules move, are renamed, or major tooling is added/removed—this file should stay lean and routing-focused.
