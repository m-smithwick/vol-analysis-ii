# Volume Analysis Project - Code Map

**Last Updated**: 2025-11-05
**Purpose**: Quick reference for upgrade spec implementation

---

## Core Analysis Pipeline

**`vol_analysis.py`** - Main orchestrator
- Entry point and CLI
- Coordinates all modules
- Single-ticker and batch analysis

**`signal_generator.py`** - Entry/exit signal logic
- Accumulation scoring (Strong Buy, Moderate Buy, Stealth)
- Exit scoring (Profit Taking, Distribution, Stop Loss)
- Primary target for Items #5, #10, #12, #13

**`indicators.py`** - Technical calculations
- Anchored VWAP (Item #1 ✅)
- Swing levels (Item #2 ✅)
- ATR/Event detection (Item #3 ✅)
- Next-day references (Item #4 ✅)
- Primary target for Items #10, #12

**`chart_builder.py`** - Visualization
- 3-panel charts with signal markers
- Displays swing levels, event days, signals

**`batch_processor.py`** - Multi-ticker processing
- HTML summary generation
- Batch ranking and scoring
- Target for Item #11 (pre-filters)

---

## Risk & Testing

**`backtest.py`** - Trade validation
- Entry-to-exit pairing
- Performance metrics
- Primary target for Items #5, #13

**`data_manager.py`** - Data fetch/cache
- Yahoo Finance integration
- Cache management with schema versioning

**`threshold_config.py`** - Signal thresholds (NEW)
- Empirically-validated thresholds (Item #8 ✅)
- Target for optimization refinement

---

## Support Modules

**`schema_manager.py`** - Cache schema management
**`error_handler.py`** - Error handling framework
**`utils.py`** - Utility functions
**`risk_manager.py`** - Comprehensive risk management framework (NEW - Item #13 ✅)
- RiskManager class for unified trade lifecycle management
- Position sizing (0.5-1% risk per trade)
- Stop placement: min(swing_low - 0.5*ATR, VWAP - 1*ATR)
- Time stops, momentum failures, profit scaling at +2R
- Trade analysis and performance reporting

---

## Simplification Touchpoints (Priority Order)

1. Limit entries to `Confluence_Signal` + `Stealth_Accumulation` (`signal_generator.py`, `backtest.py`)
2. Enforce bullish regime + liquidity minimums (`regime_filter.py`, signal prefilters)
3. Raise accumulation thresholds (`threshold_config.py`)
4. Make RiskManager path default for batch/CLI (`batch_backtest.py`, `backtest.py`)
5. Tighten time-stop window (`risk_manager.py`)
6. Tier position sizing by signal quality (`risk_manager.py`)
7. Retire weak exit rules via aggregate stats (`backtest.py`)

---

## Upgrade Status Matrix

### Completed
- ✅ Item #1: Anchored VWAP (indicators.py, signal_generator.py)
- ✅ Item #2: Swing Support/Resistance (indicators.py, chart_builder.py)
- ✅ Item #3: Event Spike Filter (indicators.py, signal_generator.py)
- ✅ Item #4: Next-Day Execution (indicators.py, backtest.py, chart_builder.py)
- ✅ Item #6: Market/Sector Regime Filter (regime_filter.py, vol_analysis.py)
  - Implemented: 2025-11-05
  - SPY > 200DMA AND Sector ETF > 50DMA pre-filter
  - Comprehensive sector mapping for all major stocks
- ✅ Item #8: Threshold Optimization (threshold_config.py, signal_generator.py)
- ✅ Item #10: CMF Replacement (indicators.py, signal_generator.py, vol_analysis.py, chart_builder.py)
  - Implemented: 2025-11-05
  - Added calculate_cmf() and calculate_cmf_zscore() functions
  - Replaced A/D + OBV with single CMF indicator
  - Fixed FutureWarnings in chart_builder.py
- ✅ Item #11: Pre-Trade Quality Filters (indicators.py, signal_generator.py, vol_analysis.py)
  - Implemented: 2025-11-05
  - Three-layer filtering: liquidity ($5M), price ($3), earnings (T-3 to T+3)
- ✅ Item #12: Z-Score Normalization (indicators.py, signal_generator.py, vol_analysis.py)
  - Implemented: 2025-11-05
  - Standardized feature weighting across different stocks
- ✅ Item #13: RiskManager Framework (risk_manager.py, test_risk_manager.py)
  - Implemented: 2025-11-05
  - Complete trade lifecycle management from sizing to exit
  - Risk-based position sizing, stop placement, exit conditions
  - Profit scaling at +2R with trailing stops
  - All tests passed ✓
- ✅ Item #5: P&L-Aware Exit Logic (signal_generator.py, backtest.py, risk_manager.py)
  - Implemented: 2025-11-05
  - Batch and CLI backtests routed through RiskManager for execution realism

### Ready to Implement (Specs Complete)
- ⏸️ Item #9: Validation Framework (prevent overfitting)

### Planned
- ⏸️ Item #7: Further modularization (optional)

---

## File → Upgrade Item Quick Reference

```
indicators.py      → Items #10, #12 (CMF, z-scores)
signal_generator.py → Items #5, #10, #12, #13 (exits, CMF, z-scores, risk)
backtest.py        → Items #5, #13 (P&L exits, RiskManager)
vol_analysis.py    → Items #6, #11 (regime filter, pre-filters)
batch_processor.py → Item #11 (pre-filters)

NEW FILES CREATED:
- regime_filter.py → Item #6 ✅ (market/sector regime checks)
- risk_manager.py → Item #13 ✅ (comprehensive risk framework)
- test_risk_manager.py → Item #13 ✅ (risk manager test suite)
```

---

## Key Dependencies

```
vol_analysis.py
├── data_manager.py
├── indicators.py
├── signal_generator.py
├── chart_builder.py
├── batch_processor.py
└── backtest.py

signal_generator.py
└── indicators.py (uses calculated columns)

backtest.py
└── schema_manager.py
```

---

## Implementation Priority Order

Based on upgrade spec pragmatic sequence:

1. ✅ **Item #10** (CMF) – Completed
2. ✅ **Item #12** (Z-scores) – Completed
3. ✅ **Item #11** (Pre-filters) – Completed
4. ✅ **Item #6** (Regime) – Completed
5. ✅ **Item #13** (RiskManager) – Completed
6. ✅ **Item #5** (P&L Exits) – Completed
7. **Item #9** (Validation) – Next major workstream alongside simplification backlog above

---

**Maintenance**: Update only when modules change or upgrades complete.
