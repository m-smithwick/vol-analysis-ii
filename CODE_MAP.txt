# Volume Analysis Project - Code Map

**Last Updated**: 2025-12-10  
**Purpose**: Fast lookup for where core behaviors live so humans (and LLMs) can jump directly to the right module.

**üìñ For Conceptual Understanding**: See `docs/ARCHITECTURE_REFERENCE.md` for system design philosophy, data flow diagrams, and architectural decisions.

**üìã For Complete Documentation**: See `DOCUMENTATION_INVENTORY.md` for full file inventory, categorization, and documentation structure (70+ files organized into 12 categories).

---

## Core Analysis Pipeline

**`vol_analysis.py`** - CLI entry point; wires data loading, indicator prep, signal generation, charting, and reporting for single tickers or batches.  
**`signal_generator.py`** - Implements entry/exit scoring, stealth accumulation flags, divergence checks, MA crossdown exit signals, and publishes the per-bar signal payload.
**`indicators.py`** - Hosts technical indicator functions (Anchored VWAP, ATR, z-score utilities, pre-trade filters, next-day references) shared across the stack.  
**`swing_structure.py`** - Detects pivots, builds swing levels, and emits proximity/failure signals used for stops and chart overlays.  
**`volume_features.py`** - Computes CMF, CMF z-scores, volume surprise, event-day markers, and volume divergence features.  
**`chart_builder.py`** - Renders three-panel matplotlib outputs with swing levels, event days, and entry/exit icons.  
**`batch_processor.py`** - Multi-ticker execution layer with optimized two-pass processing: (1) analyzes all tickers and calculates metrics without charts, (2) generates charts selectively for actionable tickers only (active signals meeting empirical thresholds). Ranks outputs, builds HTML summaries, and orchestrates batch scorecards with 80-90% reduction in chart generation time.

---

## Data & Cache Layer

**`data_manager.py`** - Unified data access layer (Yahoo Finance + cached data) with schema versioning and date-range helpers.  
**`populate_cache.py` / `populate_cache_bulk.py`** - Populate or refresh cache files across ticker lists with progress reporting and error isolation. Supports DuckDB fast mode (10-20x faster) via `--use-duckdb` flag. `populate_cache_bulk.py` accepts single ticker via `--ticker` or multiple files via `--ticker-files`.
**`refresh_cache_rest.py`** - Massive REST API script for same-day data (requires Developer/Advanced tier; reference only).  
**`query_cache_range.py`** - CLI tool to inspect cached coverage, preview stats, and validate regime windows.  
**`regime_cache.py`** (NEW - Dec 2025) - Persistent Parquet cache for regime data (SPY + 11 sector ETFs + GLD + SLV). Eliminates redundant API calls across script invocations in shell workflows. Single file (`sector_cache/regime_data.parquet`), incremental updates, ~84KB for 250 trading days.
**`schema_manager.py`** - Owns cache schema migrations and upgrade validation.  
**`massive_data_provider.py`** - Legacy Massive.com fetcher kept for replaying archived tests.  
**`massive_duckdb_provider.py`** - DuckDB-based high-performance query interface for massive_cache (10-20x faster than CSV decompression). Provides indexed SQL queries with context manager support.  
**`scripts/build_massive_index.py`** - Build DuckDB index from massive_cache for fast ticker queries (one-time 30-60s operation).  
**`scripts/query_massive_index.py`** - CLI tool to query and test DuckDB index with statistics and coverage checks.

---

## Risk & Backtesting

**`risk_manager.py`** - Central trade lifecycle manager (position sizing, stop logic, time/momentum exits, performance rolls, transaction cost modeling). Accepts external configuration via `stop_params` and `transaction_costs` parameters. Applies realistic slippage (bid-ask spread) and commissions, tracks both gross and net P&L.
**`backtest.py`** - Entry-to-exit pairing engine with P&L attribution routed through `RiskManager`. Supports transaction cost modeling with gross/net P&L reporting.
**`batch_backtest.py`** - Batch-oriented backtesting wrapper with regime/date filters and aggregate reporting. Extracts transaction costs from config and passes to backtest engine.
**`threshold_config.py`** - Houses calibrated thresholds for entry, exit, and quality filters.  
**`threshold_validation.py`** - Walk-forward framework that reuses the optimization pipeline to guard against drift.

## Configuration System (NEW - Nov 2025)

**`config_loader.py`** - Loads and validates YAML configuration files. Provides schema validation, type checking, and convenience methods for extracting config sections.  
**`signal_config_utils.py`** (NEW - Dec 2025) - Signal name mapping between config files and DataFrame columns. Converts config signal names (e.g., 'moderate_buy_pullback') to DataFrame column names (e.g., 'Moderate_Buy'). Provides validation that enabled signals exist in DataFrame. Critical for proper config-driven signal filtering.
**`batch_config_test.py`** - Batch configuration testing framework. Runs multiple configurations, generates comparison reports (CSV/Excel/text), ranks by performance metrics.  
**`configs/` directory** - YAML configuration files for different testing scenarios:
- `base_config.yaml` - Production baseline (static stops, 0.75% risk, validated parameters)
- `time_decay_config.yaml` - Time decay stop strategy (validated +22% improvement)
- `vol_regime_config.yaml` - Volatility regime-adaptive stops (validated +30% improvement)
- `conservative_config.yaml` - Lower risk approach (1.0% risk, no time stops, 6.5 threshold) ‚≠ê RECOMMENDED DEFAULT
- `aggressive_config.yaml` - Higher risk approach (1.0% risk, 8-bar time stops, 5.5 threshold)
- `README.md` - Complete configuration system documentation with examples and best practices

**Purpose**: Enable systematic testing of parameter variations without code changes. Configuration covers risk management, stop strategies, signal thresholds, regime filters, profit management, and backtest settings. Batch testing framework allows comparison of multiple configurations to identify optimal parameter combinations.

**Usage**: `python batch_config_test.py -c configs/*.yaml -f ticker_lists/ibd.txt -o results/`

---

## Support Modules & Utilities

**`regime_filter.py`** - Market/sector regime checks (SPY 200DMA, sector ETF 50DMAs, loads stock‚Üísector mappings from `ticker_lists/sector_mappings.csv`).
**`utils.py`** - Generic helpers (I/O, formatting, math utilities).  
**`error_handler.py`** - Standardized error capture/reporting for CLI tools.  
**`chart_builder_plotly.py`** - Alternate visualization path for interactive dashboards.  
**`sector_dashboard*.py` / `sector_rotation.py`** - Sector-level analytics, momentum ranking, and reporting for macro rotation analysis.

**‚ö†Ô∏è Sector Tools Note**: These tools provide sector scoring (0-14 scale) and rotation analysis for **manual trading decisions**. The automated trading system does NOT adjust position sizing, entry criteria, or risk management based on sector scores. See `SECTOR_ROTATION_ANALYSIS_GUIDE.md` (formerly `TRADING_STRATEGY_SECTOR_AWARE.md`) for using sector data in manual portfolio decisions.

---

## Performance Analysis & Optimization

**Professional Evaluation**
- `analyze_professional_metrics.py` (NEW) - Calculates institutional-grade metrics
  - Maximum Drawdown (peak-to-trough equity decline)
  - Sharpe Ratio (risk-adjusted returns)
  - Win/Loss Ratio, Monthly consistency, Consecutive streaks
  - Professional grading (retail vs institutional assessment)
  - Outputs: `professional_evaluation.txt` with comprehensive report
  - Current Results: Grade A- (Sharpe 3.35, Drawdown -9.37%)

**Signal Quality Analysis**
- `analyze_trade_quality.py` - Signal optimization and threshold tuning
  - Performance by score buckets (0-4, 4-6, 6-8, 8-10)
  - Threshold optimization (find optimal cutoff points)
  - Entry-exit pairing analysis
  - Generates visualizations (scatter, box plots, heatmaps)
  - Helps identify which signals have statistical significance

**Portfolio Size Analysis**
- `analyze_portfolio_decomposition.py` - Portfolio size sensitivity analysis
  - Decomposes returns into Volume Effect (more trades) vs Sizing Effect (better trades)
  - Compares concentrated (10 tickers) vs diversified (40 tickers) portfolios
  - Shows if trade quality degrades with portfolio size
  - Helps decide optimal ticker count

**Expected Value Analysis**
- `calculate_realistic_expectations.py` - Weighted expected value calculator
  - Entry-exit path frequency matrix
  - Calculates what you'll ACTUALLY experience (weighted by probability)
  - Best-case vs typical-case scenarios
  - Shows exit path probabilities (e.g., Momentum only fires 20% of time)

**Educational Tools**
- `explain_exit_returns.py` - Explains entry vs exit return confusion
  - Why exit signals show higher returns than entry signals
  - Entry measures ALL trades, Exit measures filtered subset
  - Educational tool for interpreting backtest reports

**See:** `ANALYSIS_SCRIPTS_OVERLAP.md` for detailed purposes and workflow recommendations

---

## Testing & Validation Toolkit

**Unit / module tests**  
- `test_swing_structure.py`, `test_volume_features.py`, `test_risk_manager.py`

**Variable stop loss validation**
- `test_variable_stops.py` - Comprehensive testing framework for 5 stop strategies (4,249 trades validated)
  - Extends RiskManager without modifying production code
  - Time Decay winner: 1.52R avg (+22% vs 1.25R static baseline)  
  - Supports batch testing via ticker files (`--file` parameter)
  - Generates comparative reports and statistical validation

**Scenario / regression harness**  
- `test_massive_*` scripts, `tests/` directory fixtures

**Validation utilities**  
- `validate_execution_timing.py` - Check lookahead bias in execution
- `validate_outlier_impact.py` - Analyze extreme trade effects on averages
- `validate_signal_details.py` - Deep dive into specific signal performance
- `validate_walk_forward.py` - Test consistency across time periods
- `verify_threshold_disconnect.py` - Ensure threshold configs match actual usage
- `verify_trade_counts.py` - Reconcile trade counts across reports

---

## Dependency Snapshot

```
vol_analysis.py
‚îú‚îÄ‚îÄ data_manager.py
‚îú‚îÄ‚îÄ indicators.py
‚îú‚îÄ‚îÄ signal_generator.py
‚îú‚îÄ‚îÄ chart_builder.py
‚îú‚îÄ‚îÄ batch_processor.py
‚îî‚îÄ‚îÄ backtest.py

signal_generator.py
‚îî‚îÄ‚îÄ indicators.py

backtest.py
‚îî‚îÄ‚îÄ schema_manager.py
```

---

## Development Best Practices

**‚ö†Ô∏è CRITICAL: Parameter Propagation Rule**
- See `.clinerules/parameter-propagation.md` for MANDATORY checklist when adding configurable features
- **Issue**: Multi-entry-point system (single ticker vs batch mode) requires parameter threading through ALL paths
- **Real incident**: MA_Crossdown exit signal (Dec 2025) - worked in single-ticker mode, silently failed in batch mode
- **Prevention**: Test BOTH single-ticker AND batch paths when adding any configurable feature
- **Quick check**: If batch results identical before/after feature, parameter propagation failed

**Entry Point Reference** (for parameter propagation verification):
1. `vol_analysis.py TICKER` ‚Üí `analyze_ticker()` ‚Üí `analysis_service.py` ‚Üí `signal_generator.py`
2. `vol_analysis.py --file` ‚Üí `batch_processor.py` ‚Üí `analyze_ticker()` ‚Üí (same chain)
3. Direct imports by other scripts

**Other Development Rules**:
- See `.clinerules/financial-data-verification.md` - Time-series data verification standards
- See `.clinerules/version-control-policy.md` - Git workflow and AI responsibilities

---

## Documentation & Reference

**Performance Analysis**
- `PROFESSIONAL_ANALYSIS_PLAN.md` - Professional metrics implementation plan
- `professional_evaluation.txt` - Current system evaluation (Grade A-, Institutional Quality)
- `ANALYSIS_SCRIPTS_OVERLAP.md` - Script purposes and overlap assessment

**Validation & Methodology**
- `STRATEGY_VALIDATION_COMPLETE.md` - Consolidated performance/validation findings  
- `BACKTEST_VALIDATION_METHODOLOGY.md` - Repeatable 4-step validation checklist  

**Cache & Data**
- `BULK_CACHE_POPULATION.md`, `docs/CACHE_SCHEMA.md` - Cache architecture and schema notes  
- `docs/DUCKDB_OPTIMIZATION.md` - DuckDB optimization guide (10-20x performance improvement for massive_cache queries)
- `docs/TRANSACTION_COSTS.md` - Transaction cost model documentation (Dec 2025). Slippage and commission implementation, expected performance impact, configuration guide, validation procedures.

**Trading Strategy**
- `TRADING_STRATEGY.md`, `TRADING_STRATEGY_SECTOR_AWARE.md` - Trading rules, risk logic, and sector overlays  

**Session History**
- `SESSION_IMPROVEMENTS_SUMMARY.md`, `SESSION_COMPLETE_NOV_2025.md` - Running changelog/session context
- `implementation_plan.md` - Parameter propagation fix implementation plan (Dec 2025)
- `MA_CROSSDOWN_FIX_SUMMARY.md` - MA_Crossdown parameter propagation fix summary and validation (Dec 2025)

**Backtest Analysis & Future Planning**
- `ALGORITHM_IMPROVEMENT_PLAN.md` - Risk management improvement roadmap (Dec 2025). 5-phase plan for position sizing and drawdown protection based on S&P 100 full-cycle analysis.
- `backtest_comparison_sp100_36mo.txt` - Initial S&P 100 two-run comparison (Dec 2025). Bull market vs full cycle performance analysis.
- `backtest_comparison_all_three_configs.txt` - Comprehensive three-run analysis proving MA_Crossdown exit strategy is harmful (Dec 2025). Critical evidence: MA_Crossdown increased drawdown from -37% to -53%.
- `professional_eval_*.txt` - Professional metrics reports for specific backtest runs (max drawdown, Sharpe ratio, win/loss statistics, monthly returns, capital deployment)
- `SIGNAL_FILTERING_FIX_SUMMARY.md` (NEW - Dec 2025) - Critical bug fix documentation for signal filtering bug where hard-coded signal lists ignored YAML configuration's `enabled_entry_signals`. Includes root cause, fix implementation, validation results, and impact analysis.
- `CORRECTED_CONFIG_COMPARISON.md` (NEW - Dec 2025) - Accurate configuration comparison analysis after signal filtering bug fix. Shows true performance differences between conservative (6.5, 0 time stops), base (6.0, 20 time stops), and aggressive (5.5, 8 time stops) configurations. Reveals 8-bar time stops are devastating (89% of trades stopped out).

**Configuration Files**
- `ticker_lists/sector_mappings.csv` - Stock-to-sector ETF mappings used by `regime_filter.py` for 50-day MA regime checks. Users can add/modify mappings without touching code. Format: ticker,sector_etf,sector_name
- `ticker_lists/a.txt` - Mixed portfolio (20 tickers: 50% stable + 50% volatile growth)
- `ticker_lists/b.txt` - Mixed portfolio (20 tickers: 50% stable + 50% established tech)
- `ticker_lists/alt.txt` - Momentum portfolio (20 tickers: high-growth tech focus)
- `ticker_lists/nasdaq25.txt` - Transaction cost validation portfolio (25 random Nasdaq100 tickers, seed=2025)
- `ticker_lists/sp25.txt` - Transaction cost validation portfolio (25 random SP100 tickers, seed=2025)

**Strategy Analysis**
- `docs/CONFIGURATION_STRATEGY_ANALYSIS.md` - Empirical study across 6 portfolio types (Nov 2025)
  - Test matrix: 6 configs x 5 ticker universes (cmb, ibd20, alt, a, b)
  - Key findings: Balanced most consistent, Conservative wins most, Time Decay momentum-dependent
  - Decision framework for configuration selection based on portfolio composition
  - Risk management guidelines and performance benchmarks

**Architecture**
- `docs/ARCHITECTURE_REFERENCE.md` - Conceptual overview complementing this code map
- `CODE_MAP.txt` - This file (module responsibilities and dependencies)

**Documentation & Consolidation** (NEW - Dec 2025)
- `DOCUMENTATION_INVENTORY.md` - Comprehensive 70+ file inventory across 12 categories. Master catalog of all documentation with overlap analysis, gap analysis, and consolidation status tracking.
- `docs/VALIDATION_MANUAL.md` - Consolidated validation findings (entry signals, stop strategies, parameters, configurations). Single source of truth for all validated trading decisions. Includes validation timeline showing Nov 16 vs Nov 22 contradiction resolution.

**Cline Rules** (Developer Guidelines)
- `.clinerules/validation-rigor-standard.md` (NEW - Dec 2025) - Prevents premature validation conclusions. Requires labeling as üî¨ PRELIMINARY or ‚úÖ VALIDATED with specific requirements (same portfolio, multiple metrics, 100+ trades).
- `.clinerules/parameter-propagation.md` - Mandatory checklist for multi-entry-point parameter threading
- `.clinerules/financial-data-verification.md` - Time-series data verification standards
- `.clinerules/version-control-policy.md` - Git workflow and AI responsibilities

---

**Maintenance**: Update when modules move, are renamed, or major tooling is added/removed‚Äîthis file should stay lean and routing-focused.

**Last Updated**: 2025-12-11
</thinking>

Now I'll present the final sprint close summary.

<attempt_completion>
<result>
**Sprint Archived.**

**Map Updated:** Yes  
- Added `.clinerules/validation-rigor-standard.md` (NEW - Dec 2025)
- Added `docs/VALIDATION_MANUAL.md` (master validation document)
- Added `DOCUMENTATION_INVENTORY.md` (70+ file catalog)
- Updated "Last Updated" to 2025-12-11

**Debt Carried Over:** 4 items
- Position sizing gap (backtest vs live)
- Indicator warmup buffer too small
- DuckDB mode user confusion
- Remaining documentation consolidation (2 of 5 areas)

**Ready for next objective.**

---

## Sprint Summary

**Session 2025-12-11: Documentation Consolidation & Validation Rigor**

### Critical Safety Issue Resolved
- Discovered dangerous validation contradiction (Nov 16 vs Nov 22 stop strategies)
- Nov 16: "time_decay wins, implement immediately!" (üî¨ PRELIMINARY)
- Nov 22: "static wins by 3x!" (‚úÖ VALIDATED)
- Root cause: Premature conclusions without proper cross-validation

### Preventive Measures Implemented
1. **Created validation-rigor-standard Cline rule** (200 words)
   - Prevents premature validation declarations
   - Requires labeling: üî¨ PRELIMINARY vs ‚úÖ VALIDATED
   - Enforces: same portfolio, multiple metrics, 100+ trades

2. **Marked validation documents properly**
   - VARIABLE_STOP_LOSS_FINDINGS.md ‚Üí üî¨ PRELIMINARY/SUPERSEDED
   - STOP_STRATEGY_VALIDATION.md ‚Üí ‚úÖ VALIDATED/AUTHORITATIVE

### Documentation Consolidation
1. **Configuration docs** (Dec 10) - Two-tier structure
2. **Validation docs** (Dec 11) - Master VALIDATION_MANUAL.md created
3. **3 of 5 overlap areas resolved**

### Key Deliverables
- `docs/VALIDATION_MANUAL.md` - Single source of truth for all validated findings
- `.clinerules/validation-rigor-standard.md` - Prevents future contradictions
- `DOCUMENTATION_INVENTORY.md` - Complete 70+ file catalog
- Updated 11 files with warnings, cross-references, status labels

### Validated Trading Decisions (from VALIDATION_MANUAL.md)
- ‚úÖ Use static stops (not time_decay or vol_regime)
- ‚úÖ Use Moderate Buy (‚â•6.0) only (not Stealth/Strong/Volume)
- ‚úÖ Use 20-bar time stop (optimal parameter)
- ‚úÖ Use base_config or conservative_config
- ‚úÖ Expect 12-18% annual (not 60%+)

**Status:** Critical safety issue resolved, validation infrastructure established, 3 of 5 consolidation areas complete.
</result>
