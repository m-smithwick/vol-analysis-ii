# Volume Analysis Project - Code Map

**Last Updated**: 2025-11-05
**Purpose**: Quick reference for upgrade spec implementation

---

## Core Analysis Pipeline

**`vol_analysis.py`** - Main orchestrator
- Entry point and CLI
- Coordinates all modules
- Single-ticker and batch analysis

**`signal_generator.py`** - Entry/exit signal logic
- Accumulation scoring (Strong Buy, Moderate Buy, Stealth)
- Exit scoring (Profit Taking, Distribution, Stop Loss)
- Operates on DataFrame columns (module-agnostic)

**`indicators.py`** - Core technical indicators (REFACTORED - Item #7 âœ…)
- Anchored VWAP (Item #1 âœ…)
- ATR calculation
- Z-score normalization (Item #12 âœ…)
- Feature standardization
- Pre-trade quality filters (Item #11 âœ…)
- Next-day references (Item #4 âœ…)

**`swing_structure.py`** - Swing analysis module (NEW - Item #7 âœ…)
- Pivot detection (find_pivots)
- Swing level calculation (Item #2 âœ…)
- Proximity signals (volatility-aware)
- Swing failure patterns
- Swing strength analysis

**`volume_features.py`** - Volume analysis module (NEW - Item #7 âœ…)
- CMF calculation (Item #10 âœ…)
- CMF z-score normalization (minimum 40 days data required)
- Volume surprise/relative volume
- Event day detection (Item #3 âœ…)
- Volume divergence detection
- Climax volume detection
- **BUG FIX (2025-11-06)**: Improved z-score calculation to handle low variance periods

**`chart_builder.py`** - Visualization
- 3-panel charts with signal markers
- Displays swing levels, event days, signals

**`batch_processor.py`** - Multi-ticker processing
- HTML summary generation
- Batch ranking and scoring
- Target for Item #11 (pre-filters)

---

## Risk & Testing

**`backtest.py`** - Trade validation
- Entry-to-exit pairing
- Performance metrics
- Primary target for Items #5, #13

**`data_manager.py`** - Data fetch/cache
- Yahoo Finance integration
- Cache management with schema versioning

**`threshold_config.py`** - Signal thresholds (NEW)
- Empirically-validated thresholds (Item #8 âœ…)
- Target for optimization refinement

---

## Support Modules

**`schema_manager.py`** - Cache schema management
**`error_handler.py`** - Error handling framework
**`utils.py`** - Utility functions
**`regime_filter.py`** - Market/sector regime validation (NEW - Item #6 âœ…)
- SPY 200DMA and Sector ETF 50DMA checks
- Comprehensive sector ETF mapping
- Signal filtering based on regime

**`risk_manager.py`** - Comprehensive risk management framework (NEW - Item #13 âœ…)
- RiskManager class for unified trade lifecycle management
- Position sizing (0.5-1% risk per trade)
- Stop placement: min(swing_low - 0.5*ATR, VWAP - 1*ATR)
- Time stops, momentum failures, profit scaling at +2R
- Trade analysis and performance reporting

**`threshold_validation.py`** - Walk-forward threshold validation (Item #9 ğŸš§)
- Generates rolling train/test windows
- Reuses optimization pipeline to evaluate thresholds out-of-sample
- Flags degradation and produces summary reports

## Test Modules (Item #7: Refactor/Integration)

**`test_swing_structure.py`** - Unit tests for swing_structure module
- Tests pivot detection
- Tests swing level calculation
- Tests proximity signals (legacy and volatility-aware)
- Integration tests for complete swing workflow

**`test_volume_features.py`** - Unit tests for volume_features module
- Tests CMF calculation and z-score normalization
- Tests volume surprise and event detection
- Tests volume divergence patterns
- Integration tests for complete volume workflow

**`test_threshold_validation.py`** - Unit tests for Item #9 prototype
- Validates walk-forward window creation
- Confirms validation metrics/report generation

**`test_risk_manager.py`** - Unit tests for risk_manager module (existing)
**`test_schema_manager.py`** - Unit tests for schema_manager module (existing)
**`test_error_framework.py`** - Unit tests for error_handler module (existing)

---

## Simplification Touchpoints (Priority Order)

1. Limit entries to `Confluence_Signal` + `Stealth_Accumulation` (`signal_generator.py`, `backtest.py`)
2. Enforce bullish regime + liquidity minimums (`regime_filter.py`, signal prefilters)
3. Raise accumulation thresholds (`threshold_config.py`)
4. Make RiskManager path default for batch/CLI (`batch_backtest.py`, `backtest.py`)
5. Tighten time-stop window (`risk_manager.py`)
6. Tier position sizing by signal quality (`risk_manager.py`)
7. Retire weak exit rules via aggregate stats (`backtest.py`)

---

## Upgrade Status Matrix

### Completed
- âœ… Item #1: Anchored VWAP (indicators.py, signal_generator.py)
- âœ… Item #2: Swing Support/Resistance (indicators.py, chart_builder.py)
- âœ… Item #3: Event Spike Filter (indicators.py, signal_generator.py)
- âœ… Item #4: Next-Day Execution (indicators.py, backtest.py, chart_builder.py)
- âœ… Item #6: Market/Sector Regime Filter (regime_filter.py, vol_analysis.py)
  - Implemented: 2025-11-05
  - SPY > 200DMA AND Sector ETF > 50DMA pre-filter
  - Comprehensive sector mapping for all major stocks
- âœ… Item #8: Threshold Optimization (threshold_config.py, signal_generator.py)
- âœ… Item #10: CMF Replacement (indicators.py, signal_generator.py, vol_analysis.py, chart_builder.py)
  - Implemented: 2025-11-05
  - Added calculate_cmf() and calculate_cmf_zscore() functions
  - Replaced A/D + OBV with single CMF indicator
  - Fixed FutureWarnings in chart_builder.py
- âœ… Item #11: Pre-Trade Quality Filters (indicators.py, signal_generator.py, vol_analysis.py)
  - Implemented: 2025-11-05
  - Three-layer filtering: liquidity ($5M), price ($3), earnings (T-3 to T+3)
- âœ… Item #12: Z-Score Normalization (indicators.py, signal_generator.py, vol_analysis.py)
  - Implemented: 2025-11-05
  - Standardized feature weighting across different stocks
- âœ… Item #13: RiskManager Framework (risk_manager.py, test_risk_manager.py)
  - Implemented: 2025-11-05
  - Complete trade lifecycle management from sizing to exit
  - Risk-based position sizing, stop placement, exit conditions
  - Profit scaling at +2R with trailing stops
  - All tests passed âœ“
- âœ… Item #5: P&L-Aware Exit Logic (signal_generator.py, backtest.py, risk_manager.py)
  - Implemented: 2025-11-05
  - Batch and CLI backtests routed through RiskManager for execution realism

### Ready to Implement (Specs Complete)
- â¸ï¸ Item #9: Validation Framework (prevent overfitting)

### Planned
- â¸ï¸ Item #7: Further modularization (optional)

---

## File â†’ Upgrade Item Quick Reference

```
indicators.py      â†’ Items #10, #12 (CMF, z-scores)
signal_generator.py â†’ Items #5, #10, #12, #13 (exits, CMF, z-scores, risk)
backtest.py        â†’ Items #5, #13 (P&L exits, RiskManager)
vol_analysis.py    â†’ Items #6, #11 (regime filter, pre-filters)
batch_processor.py â†’ Item #11 (pre-filters)

NEW FILES CREATED:
- regime_filter.py â†’ Item #6 âœ… (market/sector regime checks)
- risk_manager.py â†’ Item #13 âœ… (comprehensive risk framework)
- test_risk_manager.py â†’ Item #13 âœ… (risk manager test suite)
- swing_structure.py â†’ Item #7 âœ… (modular swing/pivot analysis)
- volume_features.py â†’ Item #7 âœ… (modular volume/CMF analysis)
- test_swing_structure.py â†’ Item #7 âœ… (swing module unit tests)
- test_volume_features.py â†’ Item #7 âœ… (volume module unit tests)
```

---

## Key Dependencies

```
vol_analysis.py
â”œâ”€â”€ data_manager.py
â”œâ”€â”€ indicators.py
â”œâ”€â”€ signal_generator.py
â”œâ”€â”€ chart_builder.py
â”œâ”€â”€ batch_processor.py
â””â”€â”€ backtest.py

signal_generator.py
â””â”€â”€ indicators.py (uses calculated columns)

backtest.py
â””â”€â”€ schema_manager.py
```

---

## Implementation Priority Order

Based on upgrade spec pragmatic sequence:

1. âœ… **Item #10** (CMF) â€“ Completed
2. âœ… **Item #12** (Z-scores) â€“ Completed
3. âœ… **Item #11** (Pre-filters) â€“ Completed
4. âœ… **Item #6** (Regime) â€“ Completed
5. âœ… **Item #13** (RiskManager) â€“ Completed
6. âœ… **Item #5** (P&L Exits) â€“ Completed
7. **Item #9** (Validation) â€“ Next major workstream alongside simplification backlog above

---

**Maintenance**: Update only when modules change or upgrades complete.
