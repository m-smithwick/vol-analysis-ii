# Volume Analysis Project - Code Map

**Last Updated**: 2025-11-28  
**Purpose**: Fast lookup for where core behaviors live so humans (and LLMs) can jump directly to the right module.

---

## Core Analysis Pipeline

**`vol_analysis.py`** - CLI entry point; wires data loading, indicator prep, signal generation, charting, and reporting for single tickers or batches.  
**`signal_generator.py`** - Implements entry/exit scoring, stealth accumulation flags, divergence checks, MA crossdown exit signals, and publishes the per-bar signal payload.
**`indicators.py`** - Hosts technical indicator functions (Anchored VWAP, ATR, z-score utilities, pre-trade filters, next-day references) shared across the stack.  
**`swing_structure.py`** - Detects pivots, builds swing levels, and emits proximity/failure signals used for stops and chart overlays.  
**`volume_features.py`** - Computes CMF, CMF z-scores, volume surprise, event-day markers, and volume divergence features.  
**`chart_builder.py`** - Renders three-panel matplotlib outputs with swing levels, event days, and entry/exit icons.  
**`batch_processor.py`** - Multi-ticker execution layer with optimized two-pass processing: (1) analyzes all tickers and calculates metrics without charts, (2) generates charts selectively for actionable tickers only (active signals meeting empirical thresholds). Ranks outputs, builds HTML summaries, and orchestrates batch scorecards with 80-90% reduction in chart generation time.

---

## Data & Cache Layer

**`data_manager.py`** - Unified data access layer (Yahoo Finance + cached data) with schema versioning and date-range helpers.  
**`populate_cache.py` / `populate_cache_bulk.py`** - Populate or refresh cache files across ticker lists with progress reporting and error isolation. Supports DuckDB fast mode (10-20x faster) via `--use-duckdb` flag. `populate_cache_bulk.py` accepts single ticker via `--ticker` or multiple files via `--ticker-files`.
**`refresh_cache_rest.py`** - Massive REST API script for same-day data (requires Developer/Advanced tier; reference only).  
**`query_cache_range.py`** - CLI tool to inspect cached coverage, preview stats, and validate regime windows.  
**`schema_manager.py`** - Owns cache schema migrations and upgrade validation.  
**`massive_data_provider.py`** - Legacy Massive.com fetcher kept for replaying archived tests.  
**`massive_duckdb_provider.py`** - DuckDB-based high-performance query interface for massive_cache (10-20x faster than CSV decompression). Provides indexed SQL queries with context manager support.  
**`scripts/build_massive_index.py`** - Build DuckDB index from massive_cache for fast ticker queries (one-time 30-60s operation).  
**`scripts/query_massive_index.py`** - CLI tool to query and test DuckDB index with statistics and coverage checks.

---

## Risk & Backtesting

**`risk_manager.py`** - Central trade lifecycle manager (position sizing, stop logic, time/momentum exits, performance rolls). Accepts external configuration via `stop_params` parameter.  
**`backtest.py`** - Entry-to-exit pairing engine with P&L attribution routed through `RiskManager`.  
**`batch_backtest.py`** - Batch-oriented backtesting wrapper with regime/date filters and aggregate reporting.  
**`threshold_config.py`** - Houses calibrated thresholds for entry, exit, and quality filters.  
**`threshold_validation.py`** - Walk-forward framework that reuses the optimization pipeline to guard against drift.

## Configuration System (NEW - Nov 2025)

**`config_loader.py`** - Loads and validates YAML configuration files. Provides schema validation, type checking, and convenience methods for extracting config sections.  
**`batch_config_test.py`** - Batch configuration testing framework. Runs multiple configurations, generates comparison reports (CSV/Excel/text), ranks by performance metrics.  
**`configs/` directory** - YAML configuration files for different testing scenarios:
- `base_config.yaml` - Production baseline (static stops, 0.75% risk, validated parameters)
- `time_decay_config.yaml` - Time decay stop strategy (validated +22% improvement)
- `vol_regime_config.yaml` - Volatility regime-adaptive stops (validated +30% improvement)
- `conservative_config.yaml` - Lower risk approach (0.5% risk, no time stops)
- `aggressive_config.yaml` - Higher risk approach (1.0% risk, tight time stops)
- `README.md` - Complete configuration system documentation with examples and best practices

**Purpose**: Enable systematic testing of parameter variations without code changes. Configuration covers risk management, stop strategies, signal thresholds, regime filters, profit management, and backtest settings. Batch testing framework allows comparison of multiple configurations to identify optimal parameter combinations.

**Usage**: `python batch_config_test.py -c configs/*.yaml -f ticker_lists/ibd.txt -o results/`

---

## Support Modules & Utilities

**`regime_filter.py`** - Market/sector regime checks (SPY 200DMA, sector ETF 50DMAs, loads stock→sector mappings from `ticker_lists/sector_mappings.csv`).
**`utils.py`** - Generic helpers (I/O, formatting, math utilities).  
**`error_handler.py`** - Standardized error capture/reporting for CLI tools.  
**`chart_builder_plotly.py`** - Alternate visualization path for interactive dashboards.  
**`sector_dashboard*.py` / `sector_rotation.py`** - Sector-level analytics, momentum ranking, and reporting.

---

## Performance Analysis & Optimization

**Professional Evaluation**
- `analyze_professional_metrics.py` (NEW) - Calculates institutional-grade metrics
  - Maximum Drawdown (peak-to-trough equity decline)
  - Sharpe Ratio (risk-adjusted returns)
  - Win/Loss Ratio, Monthly consistency, Consecutive streaks
  - Professional grading (retail vs institutional assessment)
  - Outputs: `professional_evaluation.txt` with comprehensive report
  - Current Results: Grade A- (Sharpe 3.35, Drawdown -9.37%)

**Signal Quality Analysis**
- `analyze_trade_quality.py` - Signal optimization and threshold tuning
  - Performance by score buckets (0-4, 4-6, 6-8, 8-10)
  - Threshold optimization (find optimal cutoff points)
  - Entry-exit pairing analysis
  - Generates visualizations (scatter, box plots, heatmaps)
  - Helps identify which signals have statistical significance

**Portfolio Size Analysis**
- `analyze_portfolio_decomposition.py` - Portfolio size sensitivity analysis
  - Decomposes returns into Volume Effect (more trades) vs Sizing Effect (better trades)
  - Compares concentrated (10 tickers) vs diversified (40 tickers) portfolios
  - Shows if trade quality degrades with portfolio size
  - Helps decide optimal ticker count

**Expected Value Analysis**
- `calculate_realistic_expectations.py` - Weighted expected value calculator
  - Entry-exit path frequency matrix
  - Calculates what you'll ACTUALLY experience (weighted by probability)
  - Best-case vs typical-case scenarios
  - Shows exit path probabilities (e.g., Momentum only fires 20% of time)

**Educational Tools**
- `explain_exit_returns.py` - Explains entry vs exit return confusion
  - Why exit signals show higher returns than entry signals
  - Entry measures ALL trades, Exit measures filtered subset
  - Educational tool for interpreting backtest reports

**See:** `ANALYSIS_SCRIPTS_OVERLAP.md` for detailed purposes and workflow recommendations

---

## Testing & Validation Toolkit

**Unit / module tests**  
- `test_swing_structure.py`, `test_volume_features.py`, `test_risk_manager.py`

**Variable stop loss validation**
- `test_variable_stops.py` - Comprehensive testing framework for 5 stop strategies (4,249 trades validated)
  - Extends RiskManager without modifying production code
  - Time Decay winner: 1.52R avg (+22% vs 1.25R static baseline)  
  - Supports batch testing via ticker files (`--file` parameter)
  - Generates comparative reports and statistical validation

**Scenario / regression harness**  
- `test_massive_*` scripts, `tests/` directory fixtures

**Validation utilities**  
- `validate_execution_timing.py` - Check lookahead bias in execution
- `validate_outlier_impact.py` - Analyze extreme trade effects on averages
- `validate_signal_details.py` - Deep dive into specific signal performance
- `validate_walk_forward.py` - Test consistency across time periods
- `verify_threshold_disconnect.py` - Ensure threshold configs match actual usage
- `verify_trade_counts.py` - Reconcile trade counts across reports

---

## Dependency Snapshot

```
vol_analysis.py
├── data_manager.py
├── indicators.py
├── signal_generator.py
├── chart_builder.py
├── batch_processor.py
└── backtest.py

signal_generator.py
└── indicators.py

backtest.py
└── schema_manager.py
```

---

## Development Best Practices

**⚠️ CRITICAL: Parameter Propagation Rule**
- See `.clinerules/parameter-propagation.md` for MANDATORY checklist when adding configurable features
- **Issue**: Multi-entry-point system (single ticker vs batch mode) requires parameter threading through ALL paths
- **Real incident**: MA_Crossdown exit signal (Dec 2025) - worked in single-ticker mode, silently failed in batch mode
- **Prevention**: Test BOTH single-ticker AND batch paths when adding any configurable feature
- **Quick check**: If batch results identical before/after feature, parameter propagation failed

**Entry Point Reference** (for parameter propagation verification):
1. `vol_analysis.py TICKER` → `analyze_ticker()` → `analysis_service.py` → `signal_generator.py`
2. `vol_analysis.py --file` → `batch_processor.py` → `analyze_ticker()` → (same chain)
3. Direct imports by other scripts

**Other Development Rules**:
- See `.clinerules/financial-data-verification.md` - Time-series data verification standards
- See `.clinerules/version-control-policy.md` - Git workflow and AI responsibilities

---

## Documentation & Reference

**Performance Analysis**
- `PROFESSIONAL_ANALYSIS_PLAN.md` - Professional metrics implementation plan
- `professional_evaluation.txt` - Current system evaluation (Grade A-, Institutional Quality)
- `ANALYSIS_SCRIPTS_OVERLAP.md` - Script purposes and overlap assessment

**Validation & Methodology**
- `STRATEGY_VALIDATION_COMPLETE.md` - Consolidated performance/validation findings  
- `BACKTEST_VALIDATION_METHODOLOGY.md` - Repeatable 4-step validation checklist  

**Cache & Data**
- `BULK_CACHE_POPULATION.md`, `docs/CACHE_SCHEMA.md` - Cache architecture and schema notes  
- `docs/DUCKDB_OPTIMIZATION.md` - DuckDB optimization guide (10-20x performance improvement for massive_cache queries)

**Trading Strategy**
- `TRADING_STRATEGY.md`, `TRADING_STRATEGY_SECTOR_AWARE.md` - Trading rules, risk logic, and sector overlays  

**Session History**
- `SESSION_IMPROVEMENTS_SUMMARY.md`, `SESSION_COMPLETE_NOV_2025.md` - Running changelog/session context

**Configuration Files**
- `ticker_lists/sector_mappings.csv` - Stock-to-sector ETF mappings used by `regime_filter.py` for 50-day MA regime checks. Users can add/modify mappings without touching code. Format: ticker,sector_etf,sector_name
- `ticker_lists/a.txt` - Mixed portfolio (20 tickers: 50% stable + 50% volatile growth)
- `ticker_lists/b.txt` - Mixed portfolio (20 tickers: 50% stable + 50% established tech)
- `ticker_lists/alt.txt` - Momentum portfolio (20 tickers: high-growth tech focus)

**Strategy Analysis**
- `docs/CONFIGURATION_STRATEGY_ANALYSIS.md` - Empirical study across 6 portfolio types (Nov 2025)
  - Test matrix: 6 configs x 5 ticker universes (cmb, ibd20, alt, a, b)
  - Key findings: Balanced most consistent, Conservative wins most, Time Decay momentum-dependent
  - Decision framework for configuration selection based on portfolio composition
  - Risk management guidelines and performance benchmarks

**Architecture**
- `docs/ARCHITECTURE_REFERENCE.md` - Conceptual overview complementing this code map
- `CODE_MAP.txt` - This file (module responsibilities and dependencies)

---

**Maintenance**: Update when modules move, are renamed, or major tooling is added/removed—this file should stay lean and routing-focused.
