# Volume Analysis Project - Code Map

**Last Updated**: 2025-11-03 (Phase 2 Refactoring)

This document provides a comprehensive overview of the project's file structure, module purposes, and their relationships. It should be updated after each refactoring phase to reflect architectural changes.

---

## üìÅ Project Structure

### Core Modules

**`vol_analysis.py`** - Main analysis script with caching, batch processing, and visualization
- Entry point for all analysis operations
- Command-line interface and argument parsing
- Orchestrates data fetching, signal generation, and output creation
- Integrates all other modules

**`signal_generator.py`** - ‚ú® Signal generation module for all buy/sell signals (Phase 2 refactor)
- Centralized signal detection logic
- Accumulation and exit scoring algorithms
- Entry signals: Strong Buy, Moderate Buy, Stealth Accumulation, Confluence, Volume Breakout
- Exit signals: Profit Taking, Distribution Warning, Sell, Momentum Exhaustion, Stop Loss
- ~450 lines of pure signal generation logic

**`indicators.py`** - Technical indicator calculations (Phase 1 refactor)
- On-Balance Volume (OBV)
- Accumulation/Distribution Line (A/D Line)
- Volume Weighted Average Price (VWAP)
- Support Level detection
- Price-Volume correlation
- ~350 lines of technical calculations

**`backtest.py`** - Backtesting framework for validating signal performance
- Entry-to-exit trade pairing
- Strategy performance analysis
- Win rate, profit factor, and expectancy calculations
- Generates detailed backtest reports
- ~600 lines

**`error_handler.py`** - Centralized error handling and logging framework
- Error context management
- Validation functions
- Logging configuration and utilities
- ~200 lines

**`schema_manager.py`** - Database schema management for backtesting results
- Schema versioning for cache files
- Metadata management
- Data integrity validation (checksums, column validation)
- ~150 lines

**`data_manager.py`** - Data management utilities and helpers
- Yahoo Finance API integration
- Smart caching with schema versioning
- Cache management operations (clear, refresh, info)
- Incremental data updates
- ~400 lines

**`batch_backtest.py`** - Batch backtesting and strategy optimization module
- Runs backtests across multiple tickers from file input
- Aggregates trade results for statistical analysis
- Ranks entry and exit signals by performance metrics
- Generates individual ticker backtest reports
- Creates comprehensive aggregate optimization reports
- Analyzes strategy combinations across different stocks
- Provides statistical significance validation
- Command-line interface with customizable output directory
- ~700 lines of optimization and reporting logic

**`migrate_cache.py`** - Cache schema migration utility
- Migrates legacy cache files to current schema
- Validates cache file integrity
- Batch processing for multiple files

---

### Data Directories

**`data_cache/`** - Cached price data with schema versioning
- Stores historical price data locally
- Includes metadata headers with schema version, checksums, and provenance
- Reduces API calls to Yahoo Finance
- Format: `{TICKER}_{INTERVAL}_cache.csv`

**`results_volume/`** - Analysis output directory
- Individual ticker analysis reports
- Batch processing summaries
- HTML interactive reports
- Chart images (when `--save-charts` used)

**`backtest_results/`** - Backtest results database
- SQLite database with trade analysis
- Entry-to-exit paired trades
- Strategy performance metrics
- Historical backtest reports

---

### Configuration Files

**`.gitignore`** - Git ignore rules
- Excludes cache files, results, and sensitive data

**`stocks.txt`** - Sample ticker list for batch processing
- One ticker per line format
- Comments with # supported

**`short.txt`** - Short ticker list for testing
- Smaller subset for quick batch tests

---

### Documentation Files

**`README.md`** - Main project documentation
- Feature overview and usage guide
- Command-line interface examples
- Signal interpretation guide
- Installation and troubleshooting

**`refactor.md`** - Refactoring plan and progress
- 5-phase modularization strategy
- Current status and next steps
- Architecture goals and benefits

**`CODE_MAP.txt`** - This file
- Project structure overview
- Module purposes and relationships
- Kept up-to-date after each refactoring phase

**`upgrade_spec.md`** - Feature upgrade specifications
- Planned enhancements and new features
- Technical requirements
- Implementation notes

**`tasks.md`** - Task tracking and project management
- Current tasks and priorities
- Completed work log

**`git-workflow.md`** - Git workflow and best practices
- Branching strategy
- Commit conventions
- Collaboration guidelines

---

### Testing Files

**`test_error_framework.py`** - Error handling framework tests
- Tests error context management
- Validates error handling behavior

**`test_schema_manager.py`** - Schema manager tests
- Tests cache schema validation
- Validates migration functionality

**`test_timezone.py`** - Timezone handling tests
- Tests timezone normalization
- Validates datetime consistency

**`debug_timezone_simple.py`** - Timezone debugging utility
- Helper script for diagnosing timezone issues

---

## üîÑ Refactoring Progress

### Completed Phases

**‚úÖ Phase 1: Utilize Existing Indicators Module (2025-11-03)**
- Eliminated ~150 lines of duplicate code
- All technical indicators now use `indicators.py`
- No breaking changes to functionality

**‚úÖ Phase 2: Extract Signal Generation Logic (2025-11-03)**
- Created `signal_generator.py` (~450 lines)
- Centralized all buy/sell signal detection
- Reduced `vol_analysis.py` by ~350 lines
- All signals working correctly

**‚úÖ Phase 3: Extract Visualization Logic (2025-11-03)**
- Created `chart_builder.py` (~300 lines)
- Extracted all matplotlib plotting code into modular functions
- Complete 3-panel chart generation with signal markers
- Reduced `vol_analysis.py` by ~250 lines
- All chart functionality preserved and working correctly

### Pending Phases

**‚è∏Ô∏è Phase 4: Extract Batch Processing Logic**
- Target: Create `batch_processor.py` (~250 lines)
- Separate multi-ticker processing
- Isolate HTML summary generation

**‚è∏Ô∏è Phase 5: Extract Report Generation (Optional)**
- Target: Create `report_generator.py` (~200 lines)
- Isolate text output formatting
- Separate console output logic

---

## üéØ Module Dependencies

```
vol_analysis.py (main orchestrator)
‚îú‚îÄ‚îÄ data_manager.py (data fetching & caching)
‚îú‚îÄ‚îÄ indicators.py (technical calculations)
‚îú‚îÄ‚îÄ signal_generator.py (signal detection)
‚îú‚îÄ‚îÄ backtest.py (performance validation)
‚îú‚îÄ‚îÄ error_handler.py (error handling)
‚îî‚îÄ‚îÄ schema_manager.py (cache management)

backtest.py
‚îú‚îÄ‚îÄ schema_manager.py (database schema)
‚îî‚îÄ‚îÄ error_handler.py (error handling)

signal_generator.py
‚îî‚îÄ‚îÄ indicators.py (technical indicators - indirect via DataFrame)

data_manager.py
‚îî‚îÄ‚îÄ schema_manager.py (cache schema validation)
```

---

## üìù Maintenance Notes

- **Update Frequency**: This file should be updated after completing each refactoring phase
- **Version Control**: Keep this file in sync with actual codebase structure
- **Line Counts**: Approximate values, may vary slightly with updates
- **Dependencies**: Update dependency graph when new modules are added or relationships change

---

**Current Status**: Phase 3 complete, ready for Phase 4 (Batch Processing extraction)
