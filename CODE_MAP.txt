# Volume Analysis Project - Code Map

**Last Updated**: 2025-11-05
**Purpose**: Quick reference for upgrade spec implementation

---

## Core Analysis Pipeline

**`vol_analysis.py`** - Main orchestrator
- Entry point and CLI
- Coordinates all modules
- Single-ticker and batch analysis

**`signal_generator.py`** - Entry/exit signal logic
- Accumulation scoring (Strong Buy, Moderate Buy, Stealth)
- Exit scoring (Profit Taking, Distribution, Stop Loss)
- Primary target for Items #5, #10, #12, #13

**`indicators.py`** - Technical calculations
- Anchored VWAP (Item #1 ✅)
- Swing levels (Item #2 ✅)
- ATR/Event detection (Item #3 ✅)
- Next-day references (Item #4 ✅)
- Primary target for Items #10, #12

**`chart_builder.py`** - Visualization
- 3-panel charts with signal markers
- Displays swing levels, event days, signals

**`batch_processor.py`** - Multi-ticker processing
- HTML summary generation
- Batch ranking and scoring
- Target for Item #11 (pre-filters)

---

## Risk & Testing

**`backtest.py`** - Trade validation
- Entry-to-exit pairing
- Performance metrics
- Primary target for Items #5, #13

**`data_manager.py`** - Data fetch/cache
- Yahoo Finance integration
- Cache management with schema versioning

**`threshold_config.py`** - Signal thresholds (NEW)
- Empirically-validated thresholds (Item #8 ✅)
- Target for optimization refinement

---

## Support Modules

**`schema_manager.py`** - Cache schema management
**`error_handler.py`** - Error handling framework
**`utils.py`** - Utility functions

---

## Upgrade Status Matrix

### Completed
- ✅ Item #1: Anchored VWAP (indicators.py, signal_generator.py)
- ✅ Item #2: Swing Support/Resistance (indicators.py, chart_builder.py)
- ✅ Item #3: Event Spike Filter (indicators.py, signal_generator.py)
- ✅ Item #4: Next-Day Execution (indicators.py, backtest.py, chart_builder.py)
- ✅ Item #8: Threshold Optimization (threshold_config.py, signal_generator.py)
- ✅ Item #10: CMF Replacement (indicators.py, signal_generator.py, vol_analysis.py, chart_builder.py)
  - Implemented: 2025-11-05
  - Added calculate_cmf() and calculate_cmf_zscore() functions
  - Replaced A/D + OBV with single CMF indicator
  - Fixed FutureWarnings in chart_builder.py

### Ready to Implement (Specs Complete)
- ⏸️ Item #5: P&L-Aware Exits
  - Files: signal_generator.py, backtest.py
  - New: RiskManager integration
  
- ✅ Item #6: Market/Sector Regime Filter (regime_filter.py, vol_analysis.py)
  - Implemented: 2025-11-05
  - SPY > 200DMA AND Sector ETF > 50DMA pre-filter
  - Comprehensive sector mapping for all major stocks
  - Integrates seamlessly with signal generation pipeline
  
- ✅ Item #11: Pre-Trade Quality Filters (indicators.py, signal_generator.py, vol_analysis.py)
  - Implemented: 2025-11-05
  - Added check_liquidity(), check_price(), check_earnings_window() functions
  - Integrated with signal generation via apply_prefilters parameter
  - Three-layer filtering: liquidity ($5M), price ($3), earnings (T-3 to T+3)
  
- ✅ Item #12: Z-Score Normalization (indicators.py, signal_generator.py, vol_analysis.py)
  - Implemented: 2025-11-05
  - Added calculate_zscore() and standardize_features() functions
  - Updated accumulation scoring to use Volume_Z and TR_Z
  - Enables consistent feature weighting across different stocks
  
- ⏸️ Item #13: RiskManager Framework
  - New: risk_manager.py
  - Integration: backtest.py, signal_generator.py
  - Features: Position sizing, stop placement, profit scaling

### Planned
- ⏸️ Item #9: Validation Framework (prevent overfitting)
- ⏸️ Item #7: Further modularization (optional)

---

## File → Upgrade Item Quick Reference

```
indicators.py      → Items #10, #12 (CMF, z-scores)
signal_generator.py → Items #5, #10, #12, #13 (exits, CMF, z-scores, risk)
backtest.py        → Items #5, #13 (P&L exits, RiskManager)
vol_analysis.py    → Items #6, #11 (regime filter, pre-filters)
batch_processor.py → Item #11 (pre-filters)

NEW FILES CREATED:
- regime_filter.py → Item #6 ✅ (market/sector regime checks)

NEW FILES NEEDED:
- risk_manager.py  → Item #13 (comprehensive risk framework)
```

---

## Key Dependencies

```
vol_analysis.py
├── data_manager.py
├── indicators.py
├── signal_generator.py
├── chart_builder.py
├── batch_processor.py
└── backtest.py

signal_generator.py
└── indicators.py (uses calculated columns)

backtest.py
└── schema_manager.py
```

---

## Implementation Priority Order

Based on upgrade spec pragmatic sequence:

1. ✅ **Item #10** (CMF) - Foundation for scoring - COMPLETED
2. ✅ **Item #12** (Z-scores) - Standardization enables optimization - COMPLETED
3. ✅ **Item #11** (Pre-filters) - Quality gate before signals - COMPLETED
4. ✅ **Item #6** (Regime) - Market context validation - COMPLETED
5. **Item #13** (RiskManager) - Unified risk management - NEXT
6. **Item #5** (P&L Exits) - Integrates with RiskManager
7. **Item #9** (Validation) - Prevent overfitting

---

**Maintenance**: Update only when modules change or upgrades complete.
